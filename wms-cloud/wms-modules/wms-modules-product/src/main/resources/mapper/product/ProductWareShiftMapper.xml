<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bosch.product.mapper.ProductWareShiftMapper">

    <select id="list" resultType="com.bosch.product.api.domain.vo.ProductWareShiftVO">
        select ws.*,
        (SELECT SUM(quantity) FROM product_ware_shift pws
        WHERE pws.from_prod_order = ws.from_prod_order
        and pws.delete_flag = 0
        <if test="sourcePlantNb != null and sourcePlantNb != ''">
            AND pws.source_plant_nb like concat('%', #{sourcePlantNb}, '%')
        </if>
        <if test="sourceWareCode != null and sourceWareCode != ''">
            AND pws.source_ware_code like concat('%', #{sourceWareCode}, '%')
        </if>

        <if test="targetWareCode != null and targetWareCode != ''">
            AND pws.target_ware_code like concat('%', #{targetWareCode}, '%')
        </if>
        <if test="status != null ">
            AND (pws.status = #{status})
        </if>

        <if test="ssccNb != null and ssccNb != ''">
            AND pws.sscc_nb like concat('%', #{ssccNb}, '%')
        </if>
        <if test="fromProdOrder != null and fromProdOrder != ''">
            AND pws.from_prod_order like concat('%', #{fromProdOrder}, '%')
        </if>
        <if test="materialNb != null and materialNb != ''">
            AND pws.material_nb like concat('%', #{materialNb}, '%')
        </if>
        <if test="batchNb != null and batchNb != ''">
            AND pws.batch_nb like concat('%', #{batchNb}, '%')
        </if>
        <if test="createBy != null and createBy != ''">and pws.create_by like concat('%', #{createBy}, '%')</if>
        <if test="startCreateTime != null">and pws.create_time <![CDATA[ >= ]]> #{startCreateTime}</if>
        <if test="endCreateTime != null">and pws.create_time <![CDATA[ <= ]]> #{endCreateTime}</if>
        <if test="startUpdateTime != null">and pws.update_time <![CDATA[ >= ]]> #{startUpdateTime}</if>
        <if test="startUpdateTime != null">and pws.update_time <![CDATA[ <= ]]> #{endUpdateTime}</if>

        ) AS
        total_stock_sum,
        mm.product_name as material_name,
        tr.order_number as order_nb,tr.car_nb as carNb
        from product_ware_shift ws
        left join (SELECT * from md_product_packaging where delete_flag = '0') mm on ws.material_nb = mm.product_no
        left join transhipment_order tr on tr.product_ware_shift_id = ws.id and tr.delete_flag = 0 and tr.sscc_number =
        ws.sscc_nb
        where ws.delete_flag = 0
        <if test="sourcePlantNb != null and sourcePlantNb != ''">
            AND ws.source_plant_nb like concat('%', #{sourcePlantNb}, '%')
        </if>
        <if test="sourceWareCode != null and sourceWareCode != ''">
            AND ws.source_ware_code like concat('%', #{sourceWareCode}, '%')
        </if>
        <if test="orderNb != null and orderNb != ''">
            AND tr.order_number like concat('%', #{orderNb}, '%')
        </if>
        <if test="targetWareCode != null and targetWareCode != ''">
            AND ws.target_ware_code like concat('%', #{targetWareCode}, '%')
        </if>
        <if test="status != null ">
            AND (ws.status = #{status})
        </if>
        <if test="carNb != null and carNb != ''">
            AND tr.car_Nb like concat('%', #{carNb}, '%')
        </if>
        <if test="ssccNb != null and ssccNb != ''">
            AND ws.sscc_nb like concat('%', #{ssccNb}, '%')
        </if>
        <if test="fromProdOrder != null and fromProdOrder != ''">
            AND ws.from_prod_order like concat('%', #{fromProdOrder}, '%')
        </if>
        <if test="materialNb != null and materialNb != ''">
            AND ws.material_nb like concat('%', #{materialNb}, '%')
        </if>
        <if test="batchNb != null and batchNb != ''">
            AND ws.batch_nb like concat('%', #{batchNb}, '%')
        </if>
        <if test="createBy != null and createBy != ''">and ws.create_by like concat('%', #{createBy}, '%')</if>
        <if test="startCreateTime != null">and ws.create_time <![CDATA[ >= ]]> #{startCreateTime}</if>
        <if test="endCreateTime != null">and ws.create_time <![CDATA[ <= ]]> #{endCreateTime}</if>
        <if test="startUpdateTime != null">and ws.update_time <![CDATA[ >= ]]> #{startUpdateTime}</if>
        <if test="startUpdateTime != null">and ws.update_time <![CDATA[ <= ]]> #{endUpdateTime}</if>

        order by create_time desc,update_time desc
    </select>

</mapper>