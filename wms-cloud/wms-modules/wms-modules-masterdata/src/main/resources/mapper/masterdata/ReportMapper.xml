<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bosch.masterdata.mapper.ReportMapper">

<select id="getCellCode" resultType="String">
    SELECT CODE from md_department GROUP BY CODE
</select>
    <select id="toBeReceived" resultType="com.bosch.masterdata.api.domain.MissionMap">
        SELECT md.code AS code, COUNT(md.code) as number
        FROM si_material_receive mr
                 left join md_material mm on mr.material_nb = mm.code and mm.delete_flag = 0
                 LEFT JOIN md_material_type mt ON mm.material_type_id = mt.id
                 left join md_department md on mt.department_id = md.id
        WHERE
            -- mr.STATUS=0 AND
            mr.delete_flag=0
            -- AND  md.code='NMD'
        <if test="code != null and code != ''">AND  md.code=#{code}</if>
        GROUP BY code
    </select>

    <select id="toBeBin" resultType="com.bosch.masterdata.api.domain.MissionMap">
        SELECT count(md.code) AS number, md.code AS code
        FROM si_material_in sm
                 LEFT JOIN bi_in bi ON bi.sscc_number = sm.sscc_number AND bi.delete_flag = 0
                 LEFT JOIN si_material_receive smr ON smr.sscc_number = sm.sscc_number AND smr.delete_flag = 0
                 LEFT JOIN md_material mm ON sm.material_nb = mm.code AND mm.delete_flag = 0
                 LEFT JOIN md_material_type mt ON mm.material_type_id = mt.id
                 left join md_department md on mt.department_id = md.id
        WHERE sm.delete_flag = 0
          AND NOT EXISTS (SELECT 1 FROM bi_in WHERE bi_in.sscc_number = sm.sscc_number AND bi_in.delete_flag = 1)
        <if test="code != null and code != ''">AND  md.code=#{code}</if>
          AND (bi.status = 0
                or
               sm.sscc_number not in (SELECT sscc_number from bi_in WHERE delete_flag = 0 and `status` = 1))
        GROUP BY md.code
    </select>
</mapper>